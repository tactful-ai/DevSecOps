# Use a specific Alpine Linux version
FROM alpine:3.15.3
WORKDIR /app

# Install required dependencies
RUN apk --no-cache add wget git build-base python3 python3-dev py3-setuptools py3-pip && \
    mkdir /app/scan-results && \
    wget -O /usr/local/bin/kubectl https://storage.googleapis.com/kubernetes-release/release/v1.22.2/bin/linux/amd64/kubectl && \
    chmod +x /usr/local/bin/kubectl

# Install pip and wheel
RUN python3 -m ensurepip && \
    rm -r /usr/lib/python*/ensurepip && \
    pip3 install --upgrade pip setuptools wheel

# Install ruamel.yaml before installing kube-hunter to avoid version conflicts
RUN pip3 install ruamel.yaml

# Clone kube-hunter from GitHub and build it
RUN git clone https://github.com/aquasecurity/kube-hunter.git && \
    cd kube-hunter && \
    python3 setup.py install && \
    cd .. && \
    rm -rf kube-hunter

# Copy your scan.sh script
COPY trivy_linux_amd64 /usr/local/bin/trivy
COPY scan.sh /app/
RUN chmod +x /app/*.sh /usr/local/bin/trivy

# Metadata as described in the labels-schema convention
LABEL maintainer="Mariam Osama"
LABEL description="Kubernetes Cluster Scanner Tool"

# Set the working directory
WORKDIR /app

# Define the command to run your application
CMD ["./scan.sh"]

